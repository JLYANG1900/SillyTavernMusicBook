<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Creator Cloud</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@300;400&family=Noto+Serif+SC:wght@300;400;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app-root">
        <!-- ===== Header ===== -->
        <header class="app-header">
            <div class="logo-title">
                <span class="disc-icon"><i class="fa-solid fa-compact-disc"></i></span>
                <span class="brand">BRAUN</span>
                <span class="model">AUDIO 310</span>
            </div>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="player">
                    <i class="fa-solid fa-headphones"></i>
                    <span class="tab-text">播放器</span>
                </button>
                <button class="tab-btn" data-tab="reader">
                    <i class="fa-solid fa-book-open"></i>
                    <span class="tab-text">阅读器</span>
                </button>
                <button class="tab-btn" data-tab="creator">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span class="tab-text">创作</span>
                </button>
                <button class="tab-btn" data-tab="works">
                    <i class="fa-solid fa-music"></i>
                    <span class="tab-text">作品</span>
                </button>
            </nav>
        </header>

        <!-- ===== Main Layout ===== -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="main-sidebar">
                <div class="sidebar-top">
                    <div class="sidebar-title">
                        <span>音乐</span>
                        <span>创作</span>
                        <span>云</span>
                    </div>
                </div>

                <nav class="sidebar-menu">
                    <button class="menu-btn" id="btn-import" title="导入聊天记录">
                        <i class="fa-solid fa-file-import"></i>
                        <span class="menu-label">导入</span>
                    </button>
                    <button class="menu-btn" id="btn-chat-list" title="对话列表">
                        <i class="fa-solid fa-list-ul"></i>
                        <span class="menu-label">目录</span>
                    </button>
                    <button class="menu-btn" id="btn-memories" title="记忆列表">
                        <i class="fa-solid fa-music"></i>
                        <span class="menu-label">记忆</span>
                    </button>
                    <button class="menu-btn" id="btn-bookmarks" title="书签列表">
                        <i class="fa-solid fa-bookmark"></i>
                        <span class="menu-label">书签</span>
                    </button>
                    <button class="menu-btn" id="btn-api" title="API 设置">
                        <i class="fa-solid fa-key"></i>
                        <span class="menu-label">API</span>
                    </button>
                    <button class="menu-btn" id="btn-sidebar-theme" title="夜间模式切换">
                        <i class="fa-solid fa-moon"></i>
                        <span class="menu-label">主题</span>
                    </button>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="content-area">

                <!-- ===== Tab: Player ===== -->
                <section id="tab-player" class="tab-content active">
                    <div class="player-section">
                        <!-- Playlist Area -->
                        <div class="playlist-area">
                            <div class="playlist-overlay" id="playlist-container">
                                <div class="playlist-empty">
                                    <span class="music-icon"><i class="fa-solid fa-music"></i></span>
                                    <span class="empty-text">No Tape Loaded</span>
                                </div>
                            </div>
                        </div>

                        <!-- Player Controls -->
                        <div class="player-controls">
                            <div class="control-group">
                                <input type="file" id="file-input-audio" accept="audio/*" style="display:none;">
                                <div class="btn-row">
                                    <button class="ctrl-btn" id="btn-upload" title="本地上传">
                                        <i class="fa-solid fa-upload"></i>
                                    </button>
                                    <button class="ctrl-btn" id="btn-link" title="添加链接">
                                        <i class="fa-solid fa-link"></i>
                                    </button>
                                </div>
                                <span class="ctrl-label">Load / Link</span>
                            </div>

                            <div class="playback-group">
                                <button class="ctrl-btn" id="btn-prev" title="上一曲">
                                    <i class="fa-solid fa-backward-step"></i>
                                </button>
                                <button class="ctrl-btn play-btn" id="btn-play" title="播放/暂停">
                                    <i class="fa-solid fa-play" id="play-icon"></i>
                                </button>
                                <button class="ctrl-btn" id="btn-next" title="下一曲">
                                    <i class="fa-solid fa-forward-step"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== Tab: Reader ===== -->
                <section id="tab-reader" class="tab-content">
                    <div class="reader-header">
                        <div class="chat-title" id="current-chat-title">未选择对话</div>
                        <div class="page-indicator" id="page-info" onclick="App.chat.promptJumpToPage()" title="点击跳转页码">
                            P. 0 / 0</div>
                    </div>

                    <div class="chat-container" id="chat-container">
                        <div class="empty-state">
                            <i class="fa-solid fa-book-open"></i>
                            <p>请导入聊天记录或在目录中选择</p>
                            <button class="action-btn" onclick="document.getElementById('file-input-chat').click()">
                                <i class="fa-solid fa-file-import"></i> 导入 JSON
                            </button>
                        </div>
                    </div>

                    <div class="pagination-bar" id="pagination-bar">
                        <button class="page-btn" onclick="App.chat.changePage(-1)">
                            <i class="fa-solid fa-chevron-left"></i> 上一页
                        </button>
                        <span class="page-dots">· · ·</span>
                        <button class="page-btn" onclick="App.chat.changePage(1)">
                            下一页 <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </section>

                <!-- ===== Tab: Creator ===== -->
                <section id="tab-creator" class="tab-content">
                    <div class="creator-layout">
                        <!-- Left: Story & Memory & Background Info -->
                        <div class="left-sidebar-panel">
                            <!-- Story Selector Panel -->
                            <div class="story-panel">
                                <div class="panel-header">
                                    <h3><i class="fa-solid fa-book"></i> 故事</h3>
                                    <button class="btn-text" onclick="App.story.openModal()">
                                        + 添加更多
                                    </button>
                                </div>
                                <div class="story-list" id="story-list">
                                    <!-- Story items will be rendered here -->
                                </div>
                                <div class="empty-state" id="no-story-hint">
                                    <i class="fa-solid fa-book"></i>
                                    <p>添加故事来分类你的创作记忆</p>
                                </div>
                            </div>

                            <div class="memory-preview-panel">
                                <div class="panel-header">
                                    <h3><i class="fa-solid fa-bookmark"></i> 已选择的记忆 (<span id="memory-count">0</span>)
                                    </h3>
                                    <button class="btn-text" onclick="App.ui.switchTab('reader')">
                                        + 添加更多
                                    </button>
                                </div>

                                <div class="memory-list-compact" id="memory-preview-list">
                                    <!-- Memory cards will be rendered here -->
                                </div>

                                <div class="empty-state" id="no-memory-hint">
                                    <i class="fa-solid fa-bookmark"></i>
                                    <p>请先在阅读器中选择记忆</p>
                                    <button class="action-btn" onclick="App.ui.switchTab('reader')">
                                        前往阅读器
                                    </button>
                                </div>
                            </div>

                            <!-- Background Info Panel -->
                            <div class="background-info-panel">
                                <div class="panel-header">
                                    <h3><i class="fa-solid fa-scroll"></i> 补充背景信息 (<span id="bg-info-count">0</span>)
                                    </h3>
                                    <button class="btn-text" onclick="App.bgInfo.openModal()">
                                        + 添加更多
                                    </button>
                                </div>

                                <div class="bg-info-list" id="bg-info-list">
                                    <!-- Background info items will be rendered here -->
                                </div>

                                <div class="empty-state" id="no-bg-info-hint">
                                    <i class="fa-solid fa-scroll"></i>
                                    <p>添加角色人设、世界观等背景信息</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Style Selector -->
                        <div class="style-selector-panel">
                            <div class="form-scroll">
                                <!-- 01 / Creator Profile -->
                                <div class="form-group">
                                    <label class="form-label">01 / Creator Profile</label>
                                    <div class="input-wrapper">
                                        <input type="text" id="char-name" class="form-input"
                                            placeholder="Enter Character Name...">
                                        <span class="input-hint">你想要让哪个角色来创作音乐？</span>
                                    </div>
                                </div>

                                <!-- 02 / Vocal Range -->
                                <div class="form-group">
                                    <label class="form-label">02 / Vocal Range</label>
                                    <div class="btn-grid vocal-grid" id="vocal-btns">
                                        <!-- JS will populate -->
                                    </div>
                                    <div class="gender-selector" id="gender-selector" style="display:none;">
                                        <span class="gender-label">指定性别:</span>
                                        <button class="gender-btn" data-gender="男">男 (Male)</button>
                                        <button class="gender-btn" data-gender="女">女 (Female)</button>
                                    </div>
                                    <!-- 声部音色面板 -->
                                    <div class="timbre-panel" id="timbre-panel">
                                        <div class="timbre-header">
                                            <span class="music-icon"><i class="fa-solid fa-microphone"></i></span>
                                            <span class="timbre-title">声部音色</span>
                                        </div>
                                        <div class="btn-grid timbre-grid" id="timbre-btns">
                                            <!-- JS will populate -->
                                        </div>
                                    </div>
                                    <p class="form-note">* 如果不确定角色的音域，请选择最后一项由 AI 判断</p>
                                </div>

                                <!-- 03 / Genre -->
                                <div class="form-group">
                                    <label class="form-label">03 / Musical Genre</label>
                                    <div class="btn-grid genre-grid" id="genre-btns">
                                        <!-- JS will populate -->
                                    </div>
                                    <div class="subgenre-panel" id="subgenre-panel" style="display:none;">
                                        <div class="subgenre-header">
                                            <span class="music-icon"><i class="fa-solid fa-sliders"></i></span>
                                            <span class="subgenre-title">Sub-Genre</span>
                                            <span class="genre-desc" id="genre-desc"></span>
                                        </div>
                                        <div class="btn-grid subgenre-grid" id="subgenre-btns">
                                            <!-- JS will populate -->
                                        </div>
                                        <div class="subgenre-desc" id="subgenre-desc" style="display:none;">
                                            <!-- Selected sub-genre description will appear here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- 04 / Instruments -->
                                <div class="form-group" id="instrument-group" style="display:none;">
                                    <label class="form-label">04 / Lead Instrument</label>
                                    <div class="instrument-container" id="instrument-btns">
                                        <!-- JS will populate -->
                                    </div>
                                </div>

                                <!-- 05 / Lyrics Concept -->
                                <div class="form-group">
                                    <label class="form-label">05 / Lyrics Concept</label>
                                    <div class="lyrics-panel" id="lyrics-panel">
                                        <!-- 歌词语言 -->
                                        <div class="lyrics-section">
                                            <div class="lyrics-section-header">
                                                <span class="music-icon"><i class="fa-solid fa-language"></i></span>
                                                <span class="lyrics-section-title">歌词语言</span>
                                            </div>
                                            <div class="btn-grid lang-grid" id="lang-btns">
                                                <!-- JS will populate -->
                                            </div>
                                            <input type="text" id="lang-custom" class="form-input lyrics-custom-input"
                                                placeholder="其他语言...">
                                        </div>

                                        <!-- 创作模式 -->
                                        <div class="lyrics-section">
                                            <div class="lyrics-section-header">
                                                <span class="music-icon"><i class="fa-solid fa-pen-nib"></i></span>
                                                <span class="lyrics-section-title">歌词内容</span>
                                            </div>
                                            <div class="btn-grid mode-grid" id="lyric-mode-btns">
                                                <!-- JS will populate -->
                                            </div>
                                            <input type="text" id="lyric-keywords"
                                                class="form-input lyrics-custom-input" placeholder="输入你想要的歌词关键词...">
                                        </div>

                                        <!-- 韵脚方案 -->
                                        <div class="lyrics-section">
                                            <div class="lyrics-section-header">
                                                <span class="music-icon"><i class="fa-solid fa-headphones"></i></span>
                                                <span class="lyrics-section-title">韵脚方案</span>
                                            </div>
                                            <div class="btn-grid rhyme-grid" id="rhyme-btns">
                                                <!-- JS will populate -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <div class="action-footer">
                                    <div class="author-info">
                                        Music Creator Cloud · Based on ST_Music
                                    </div>
                                    <button class="create-btn" id="btn-generate" title="生成创作笔记">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                                        <span>AI 创作</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== Tab: Works ===== -->
                <section id="tab-works" class="tab-content">
                    <div class="works-layout">
                        <!-- Empty State - shown when no results -->
                        <div class="works-empty-state" id="works-empty">
                            <i class="fa-solid fa-music"></i>
                            <h3>尚无创作作品</h3>
                            <p>前往「创作」页面生成您的第一首歌曲</p>
                            <button class="action-btn" onclick="App.ui.switchTab('creator')">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> 开始创作
                            </button>
                        </div>

                        <!-- Works Layout Container - side by side -->
                        <div class="works-layout" id="works-layout" style="display:none;">
                            <!-- Creation Notes Panel (left) -->
                            <div class="results-container" id="results-container">
                                <div class="results-header">
                                    <span><i class="fa-solid fa-music"></i> Creation Notes</span>
                                    <button class="copy-all-btn" id="btn-copy-all">
                                        <i class="fa-solid fa-copy"></i> 复制全部
                                    </button>
                                </div>

                                <div class="result-section">
                                    <div class="result-label-row">
                                        <span>一、歌名</span>
                                        <button class="copy-btn" id="btn-copy-title">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="result-content" id="result-title"></div>
                                </div>

                                <div class="result-section">
                                    <div class="result-label-row">
                                        <span>二、歌词结构</span>
                                        <button class="copy-btn" id="btn-copy-lyrics">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="result-content lyrics-content" id="result-lyrics"></div>
                                </div>

                                <div class="result-section">
                                    <div class="result-label-row">
                                        <span>三、风格</span>
                                        <button class="copy-btn" id="btn-copy-style">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="result-content" id="result-style"></div>
                                </div>
                            </div>

                            <!-- Raw Output Panel (right) -->
                            <div class="raw-output-container" id="raw-output-container">
                                <div class="raw-output-header" onclick="App.creator.toggleRawOutput()">
                                    <span>
                                        <i class="fa-solid fa-chevron-down raw-toggle-icon rotated"></i>
                                        <i class="fa-solid fa-terminal"></i> Output Content
                                    </span>
                                    <button class="copy-all-btn" id="btn-copy-raw"
                                        onclick="event.stopPropagation(); App.creator.copyRaw()">
                                        <i class="fa-solid fa-copy"></i> 复制
                                    </button>
                                </div>
                                <div class="raw-output-content" id="result-raw"></div>
                            </div>
                        </div>
                </section>
            </main>
        </div>

        <!-- ===== Overlay Panels ===== -->

        <!-- Chat List Panel -->
        <div id="panel-chat-list" class="overlay-panel">
            <div class="panel-header">
                <span><i class="fa-solid fa-list"></i> 档案目录</span>
                <button class="close-btn" onclick="App.ui.closePanel()">×</button>
            </div>
            <div class="panel-actions">
                <button class="danger-btn" id="btn-delete-chat" style="display:none;">删除当前记录</button>
            </div>
            <div class="panel-content" id="chat-list-content"></div>
        </div>

        <!-- Memories Panel -->
        <div id="panel-memories" class="overlay-panel">
            <div class="panel-header">
                <span><i class="fa-solid fa-music"></i> 记忆列表</span>
                <button class="close-btn" onclick="App.ui.closePanel()">×</button>
            </div>
            <div class="panel-actions">
                <button class="action-btn" onclick="App.memory.clearAll()">清空全部</button>
            </div>
            <div class="panel-content" id="memories-list-content"></div>
        </div>

        <!-- Bookmark Panel -->
        <div id="panel-bookmarks" class="overlay-panel">
            <div class="panel-header">
                <span><i class="fa-solid fa-bookmark"></i> 书签列表</span>
                <button class="close-btn" onclick="App.ui.closePanel()">×</button>
            </div>
            <div class="panel-actions">
                <button class="action-btn" onclick="App.bookmark.clearAll()">清空全部</button>
            </div>
            <div class="panel-content" id="bookmarks-list-content"></div>
        </div>

        <!-- API Settings Panel -->
        <div id="panel-api" class="overlay-panel">
            <div class="panel-header">
                <span><i class="fa-solid fa-key"></i> Gemini API 配置</span>
                <button class="close-btn" onclick="App.ui.closePanel()">×</button>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="api-key-input" class="form-input" placeholder="AIza...">
                    <p class="form-note">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank">
                            前往 Google AI Studio 获取 API Key →
                        </a>
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">模型选择</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="api-model" value="gemini-2.5-flash" checked>
                            <span class="radio-mark"></span>
                            <span>Gemini 2.5 Flash</span>
                            <span class="badge">快速 · 免费额度高</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="api-model" value="gemini-2.5-pro">
                            <span class="radio-mark"></span>
                            <span>Gemini 2.5 Pro</span>
                            <span class="badge">高质量 · 创意更强</span>
                        </label>
                    </div>
                </div>

                <div class="api-status">
                    <span id="api-status-text">未配置</span>
                </div>

                <button class="save-btn" onclick="App.api.saveConfig()">
                    <i class="fa-solid fa-check"></i> 保存配置
                </button>
            </div>
        </div>

        <!-- Link Input Modal -->
        <div id="modal-link" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>添加新歌曲</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">链接</label>
                        <input type="text" id="link-url" class="form-input"
                            placeholder="https://files.catbox.moe/XXXXXX.mp3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">歌名</label>
                        <input type="text" id="link-name" class="form-input" placeholder="请填写歌曲名">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="App.player.closeLinkModal()">取消</button>
                    <button class="btn-primary" onclick="App.player.confirmAddLink()">添加歌曲</button>
                </div>
            </div>
        </div>

        <!-- Background Info Modal -->
        <div id="modal-bg-info" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>添加背景信息</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">标题</label>
                        <input type="text" id="bg-info-title" class="form-input" placeholder="例如：角色人设、世界观、故事背景...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">内容</label>
                        <textarea id="bg-info-content" class="form-input form-textarea" placeholder="请输入详细的背景信息..."
                            rows="5"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="App.bgInfo.closeModal()">取消</button>
                    <button class="btn-primary" onclick="App.bgInfo.addInfo()">添加</button>
                </div>
            </div>
        </div>

        <!-- Story Modal -->
        <div id="modal-story" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>添加故事</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">故事标题</label>
                        <input type="text" id="story-title" class="form-input" placeholder="为这组创作记忆命名...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="App.story.closeModal()">取消</button>
                    <button class="btn-primary" onclick="App.story.addStory()">添加</button>
                </div>
            </div>
        </div>

        <!-- Page Jump Modal -->
        <div id="modal-page-jump" class="modal-overlay" style="display:none;">
            <div class="modal-box compact">
                <div class="modal-header">
                    <h3>跳转页码</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" id="page-jump-label">跳转到 (1 - 0):</label>
                        <input type="number" id="page-jump-input" class="form-input" min="1" placeholder="输入页码...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="App.chat.closePageJumpModal()">取消</button>
                    <button class="btn-primary" onclick="App.chat.confirmPageJump()">跳转</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display:none;">
            <div class="loading-spinner">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>AI 创作中...</span>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="file-input-chat" accept=".json,.jsonl,.txt" multiple style="display:none;">

    <!-- Audio Element -->
    <audio id="audio-player"></audio>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script src="app.js"></script>
</body>

</html>